import streamlit as st
import requests
from datetime import datetime
import pandas as pd
import numpy as np
import plotly.graph_objects as go

# =========================
# === CONFIG / API KEY ===
# =========================
API_KEY = "b0634f918d71f32afc9b65855dfc0f46"


# =========================
# ======  MODEL LAYER  =====
# =========================
class WeatherAPI:
    """Class untuk koneksi API ke OpenWeather."""

    def _init_(self, api_key):
        self.api_key = api_key

    def get_current_weather(self, city):
        url = f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={self.api_key}&units=metric"
        return requests.get(url).json()

    def get_forecast(self, lat, lon):
        url = f"https://api.openweathermap.org/data/2.5/forecast?lat={lat}&lon={lon}&appid={self.api_key}&units=metric"
        return requests.get(url).json()

    def get_air_quality(self, lat, lon):
        url = f"http://api.openweathermap.org/data/2.5/air_pollution?lat={lat}&lon={lon}&appid={self.api_key}"
        return requests.get(url).json()


# =========================
# ===== UTILITY CLASS =====
# =========================
class WeatherUtils:

    @staticmethod
    def rekomendasi(kondisi, suhu):
        kondisi = (kondisi or "").lower()

        if "rain" in kondisi:
            return "ğŸŒ§ Cuaca hujan â€” disarankan membawa payung atau jas hujan."
        elif "clear" in kondisi:
            if suhu is not None and suhu >= 33:
                return "â˜€ Cerah & panas â€” gunakan sunscreen dan minum cukup air."
            else:
                return "â˜€ Cerah â€” cuaca baik."
        elif "cloud" in kondisi:
            return "â˜ Mendung â€” boleh membawa jaket tipis."
        elif "storm" in kondisi or "thunder" in kondisi:
            return "â›ˆ Badai â€” hindari aktivitas di luar ruangan."
        elif "wind" in kondisi:
            return "ğŸ’¨ Berangin â€” hati-hati berkendara."

        if suhu is not None:
            if suhu >= 33:
                return "ğŸ¥µ Panas â€” minum lebih banyak."
            elif suhu <= 20:
                return "ğŸ¥¶ Dingin â€” gunakan jaket tebal."

        return "â„¹ Cuaca normal â€” tidak ada rekomendasi khusus."

    @staticmethod
    def ts_to_dt(ts):
        try:
            return datetime.utcfromtimestamp(int(ts))
        except:
            return None


# =========================
# ===== UI LAYER ==========
# =========================
class WeatherApp:

    def _init_(self):
        self.api = WeatherAPI(API_KEY)

    # --------------------
    # Plotly Chart Helper
    # --------------------
    def line_chart(self, title, x, y, y_label):
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=x, y=y, mode="lines+markers", line=dict(width=3)))

        fig.update_layout(
            title=title,
            title_x=0.0,
            xaxis_title="",
            yaxis_title=y_label,
            plot_bgcolor="white",
            paper_bgcolor="white",
            margin=dict(l=20, r=20, t=40, b=20),
            xaxis=dict(showgrid=True, gridcolor="lightgrey"),
            yaxis=dict(showgrid=True, gridcolor="lightgrey")
        )
        return fig

    # --------------------
    # HEADER
    # --------------------
    def header(self):
        st.set_page_config(page_title="Aplikasi Cuaca", layout="wide")
        st.markdown("<h1 style='text-align:center'>ğŸŒ¤ Aplikasi Cuaca</h1>", unsafe_allow_html=True)

        dark = st.checkbox("ğŸŒ™ Aktifkan Dark Mode", key="dark_mode")
        if dark:
            st.markdown("""
                <style>
                    .stApp { background:#0b0f12; color:#e6eef6; }
                </style>
            """, unsafe_allow_html=True)

    # --------------------
    # INPUT
    # --------------------
    def input_city(self):
        col, _ = st.columns([3, 1])
        with col:
            city = st.text_input("Masukkan nama kota:", value="Jakarta")
            run = st.button("Cari Cuaca")

        if run and not city.strip():
            st.error("Masukkan nama kota terlebih dahulu.")
            return None, False

        return city, run

    # --------------------
    # CURRENT WEATHER
    # --------------------
    def show_current_weather(self, data, city):
        st.markdown("## ğŸŒ Informasi Cuaca Saat Ini")
        desc = data["weather"][0]["description"]
        icon = data["weather"][0].get("icon")
        main = data["main"]
        wind = data["wind"]
        coord = data["coord"]

        col = st.columns([2, 1, 1, 1, 1])

        with col[0]:
            st.subheader(city.title())
            if icon:
                st.image(f"http://openweathermap.org/img/wn/{icon}@2x.png", width=100)
            st.write(f"*Deskripsi:* {desc}")
            st.write(f"*Suhu:* {main['temp']} Â°C")
            st.write(f"*Kelembapan:* {main['humidity']} %")
            st.write(f"*Tekanan:* {main.get('pressure')} hPa")
            st.write(f"*Angin:* {wind.get('speed')} m/s")

        col[1].metric("Suhu (Â°C)", main["temp"])
        col[2].metric("Kelembapan (%)", main["humidity"])
        col[3].metric("Angin (m/s)", wind["speed"])
        col[4].metric("Koordinat", f"{coord['lat']:.4f}, {coord['lon']:.4f}")

        st.markdown("### ğŸ“ Rekomendasi Aktivitas")
        st.info(WeatherUtils.rekomendasi(desc, main["temp"]))

        return coord["lat"], coord["lon"]

    # --------------------
    # AIR QUALITY
    # --------------------
    def show_air_quality(self, aq):
        st.markdown("## ğŸŒ« Air Quality (AQI)")

        if "list" not in aq or len(aq["list"]) == 0:
            st.write("Tidak ada data AQI.")
            return

        item = aq["list"][0]
        aqi = item["main"]["aqi"]
        comp = item["components"]

        aqi_text = {1: "Baik ğŸ˜„", 2: "Cukup Baik ğŸ™‚", 3: "Sedang ğŸ˜", 4: "Buruk ğŸ˜·", 5: "Sangat Buruk ğŸ¤¢"}
        st.metric("AQI", f"{aqi} â€” {aqi_text.get(aqi)}")

        df = pd.DataFrame([comp]).T.rename(columns={0: "Âµg/mÂ³"})
        st.dataframe(df)

    # --------------------
    # FORECAST
    # --------------------
    def show_forecast(self, forecast, lat, lon, city):
        st.markdown("## ğŸ“… Prediksi Cuaca (5 Hari â€” 3 Jam)")

        if str(forecast.get("cod")) != "200":
            st.write("Forecast tidak tersedia.")
            return

        items = forecast["list"]
        max_pts = len(items)
        pts = st.slider("Jumlah titik prediksi:", 8, max_pts, min(24, max_pts))

        rows = []
        for it in items[:pts]:
            rows.append({
                "Waktu": WeatherUtils.ts_to_dt(it["dt"]),
                "Suhu (Â°C)": it["main"]["temp"],
                "Kelembapan (%)": it["main"]["humidity"],
                "Angin (m/s)": it["wind"]["speed"],
                "Deskripsi": it["weather"][0]["description"],
            })

        df = pd.DataFrame(rows)
        st.dataframe(df)

        st.download_button("ğŸ“¥ Download CSV", df.to_csv().encode(), f"forecast_{city}.csv")

        st.markdown("### ğŸŒ¡ Grafik Suhu")
        st.plotly_chart(self.line_chart("Hourly Temperature", df["Waktu"], df["Suhu (Â°C)"], "Â°C"), use_container_width=True)

        st.markdown("### ğŸ’§ Grafik Kelembapan")
        st.plotly_chart(self.line_chart("Hourly Humidity", df["Waktu"], df["Kelembapan (%)"], "%"), use_container_width=True)

        st.markdown("### ğŸŒ¬ Kecepatan Angin")
        st.plotly_chart(self.line_chart("Hourly Wind Speed", df["Waktu"], df["Angin (m/s)"], "m/s"), use_container_width=True)

    # --------------------
    # MAIN RUN
    # --------------------
    def run(self):
        self.header()
        city, run = self.input_city()
        if not run:
            return

        with st.spinner("Mengambil data cuaca..."):
            data = self.api.get_current_weather(city)

            if str(data.get("cod")) != "200":
                st.error(f"Kota tidak ditemukan! ({data.get('message')})")
                return

            lat, lon = self.show_current_weather(data, city)

            st.markdown("## ğŸ—º Lokasi Kota")
            st.map(pd.DataFrame({"lat": [lat], "lon": [lon]}), zoom=10)

            aq = self.api.get_air_quality(lat, lon)
            self.show_air_quality(aq)

            forecast = self.api.get_forecast(lat, lon)
            self.show_forecast(forecast, lat, lon, city)

            st.success("âœ… Data berhasil diambil.")


# =========================
# ====== RUN APP ==========
# =========================
if _name_ == "_main_":
    WeatherApp().run()
